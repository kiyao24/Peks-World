{% extends "base.html" %}
{% block title %}Checkout{% endblock %}
{% block content %}
<div class="max-w-5xl mx-auto py-8 px-4">
  <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">üßæ Order Summary</h2>

  <div class="overflow-x-auto">
    <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm text-sm">
      <thead class="bg-pink-100 text-pink-800">
        <tr>
          <th class="text-left p-3">Item</th>
          <th class="text-left p-3 w-20">Qty</th>
          <th class="text-left p-3">Subtotal</th>
        </tr>
      </thead>
      <tbody>
        {% for item in cart_items %}
        <tr class="border-t hover:bg-gray-50">
          <td class="p-3">{{ item.product.name }}</td>
          <td class="p-3">{{ item.quantity }}</td>
          <td class="p-3 font-medium">‚Ç¶{{ '%.2f' % item.subtotal }}</td>
        </tr>
        {% endfor %}
        <tr class="bg-yellow-50 font-semibold border-t">
          <td colspan="2" class="p-3 text-right">Total</td>
          <td class="p-3">‚Ç¶{{ '%.2f' % total }}</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Summary Breakdown -->
  <div class="mt-6 space-y-2 text-sm">
    <p><strong>Subtotal:</strong> ‚Ç¶{{ '%.2f' % order.subtotal }}</p>
    <p><strong>Discount:</strong> -‚Ç¶{{ '%.2f' % order.discount }}</p>
    <p><strong>Tax:</strong> ‚Ç¶{{ '%.2f' % order.tax }}</p>
    <p><strong>Shipping Fee:</strong> ‚Ç¶{{ '%.2f' % order.shipping_fee }}</p>
    <hr class="my-2">
    <h4 class="text-lg font-bold">Total: ‚Ç¶{{ '%.2f' % order.total }}</h4>
  </div>

  <!-- Action Buttons -->
  <form method="POST" class="mt-6 flex flex-wrap gap-3">
    <a href="{{ url_for('view_cart') }}" class="px-4 py-2 border border-gray-400 text-gray-700 rounded hover:bg-gray-100 transition">
      ‚Üê Back to Cart
    </a>
  </form>

  <!-- Quick Checkout Section -->
  <hr class="my-8">
  <h4 class="text-lg font-semibold mb-2">üí≥ Quick Checkout (API)</h4>
  <button id="apiCheckoutBtn" type="button" class="px-5 py-2 bg-pink-600 text-white rounded hover:bg-pink-700 transition">
    Place Order via API
  </button>
</div>

<!-- JS for API Checkout -->
<script>
document.getElementById('apiCheckoutBtn').addEventListener('click', async function () {
  const cartData = {
    {% for item in cart_items %}
    "{{ item.product.id }}": {{ item.quantity }}{% if not loop.last %},{% endif %}
    {% endfor %}
  };

  try {
    const response = await fetch('/api/checkout', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ cart: cartData })
    });

    const result = await response.json();

    if (response.ok && result.redirect_url) {
      window.location.href = result.redirect_url;
    } else {
      alert('‚ùå ' + (result.error || 'Something went wrong.'));
    }
  } catch (error) {
    console.error(error);
    alert('‚ö†Ô∏è Failed to complete checkout. Please try again.');
  }
});
</script>
{% endblock %}
