{% extends 'base.html' %}
{% block title %}Your Dashboard{% endblock %}

{% block content %}
<div class="container my-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold">ğŸ‘‹ Welcome, {{ user.first_name }}</h2>
    <a href="{{ url_for('defaulthomepage') }}" class="btn btn-outline-primary">
      ğŸ¬ Back to Store
    </a>
  </div>

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, msg in messages %}
        <div class="alert alert-{{ category }}">{{ msg }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <div class="row g-4">

    <!-- Profile Image Upload -->
    <div class="col-md-4">
      <div class="card h-100 shadow-sm">
        <div class="card-header bg-dark text-white">
          ğŸ–¼ï¸ Profile Image
        </div>
        <div class="card-body text-center">
          {% if user.profile_image %}
            <img src="{{ url_for('static', filename='img/profile.jpg') }}"
                 alt="Profile Image" class="rounded-circle mb-3" width="100" height="100">
          {% endif %}
          <form method="POST" enctype="multipart/form-data" action="{{ url_for('upload_profile_image') }}">
            <input type="file" name="profile_image" class="form-control mb-2" required>
            <button type="submit" class="btn btn-outline-secondary btn-sm">Upload</button>
          </form>
        </div>
      </div>
    </div>

    <!-- Profile Edit -->
    <div class="col-md-8">
      <div class="card h-100 shadow-sm">
        <div class="card-header bg-primary text-white">ğŸ“ Edit Profile</div>
        <div class="card-body">
          <form method="POST" action="{{ url_for('update_profile') }}">
            {{ form.hidden_tag() }}
            <div class="row g-3">
              <div class="col-md-6">{{ form.first_name.label }} {{ form.first_name(class="form-control") }}</div>
              <div class="col-md-6">{{ form.last_name.label }} {{ form.last_name(class="form-control") }}</div>
              <div class="col-md-6">{{ form.email.label }} {{ form.email(class="form-control") }}</div>
              <div class="col-md-6">{{ form.phone.label }} {{ form.phone(class="form-control") }}</div>
              <div class="col-12">{{ form.address.label }} {{ form.address(class="form-control") }}</div>
            </div>
            <div class="mt-4">
              {{ form.submit(class="btn btn-success w-100") }}
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Password Change -->
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-warning">ğŸ”’ Change Password</div>
        <div class="card-body">
          <form method="POST" action="{{ url_for('change_password') }}">
            {{ password_form.hidden_tag() }}
            <div class="row g-3">
              <div class="col-md-4">{{ password_form.current_password.label }} {{ password_form.current_password(class="form-control") }}</div>
              <div class="col-md-4">{{ password_form.new_password.label }} {{ password_form.new_password(class="form-control") }}</div>
              <div class="col-md-4">{{ password_form.confirm_password.label }} {{ password_form.confirm_password(class="form-control") }}</div>
            </div>
            <div class="mt-4">
              {{ password_form.submit(class="btn btn-outline-dark w-100") }}
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Order History -->
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-secondary text-white">ğŸ§¾ Order History</div>
        <div class="card-body">
          {% if orders %}
            <ul class="list-group">
              {% for order in orders %}
                <li class="list-group-item">
                  <strong>Order #{{ order.id }}</strong><br>
                  <small class="text-muted">ğŸ“… {{ order.created_at.strftime('%b %d, %Y at %I:%M %p') }}</small><br>
                  <span>ğŸ’µ Total: â‚¦{{ '%.2f' % order.total_amount }}</span>
                  <ul class="mt-2 ms-3">
                    {% for item in order.items %}
                      <li>ğŸ›ï¸ {{ item.product.name }} x{{ item.quantity }}</li>
                    {% endfor %}
                  </ul>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="text-muted mb-0">You have not placed any orders yet.</p>
          {% endif %}
        </div>
      </div>
    </div>

  </div>
</div>
{% endblock %}
